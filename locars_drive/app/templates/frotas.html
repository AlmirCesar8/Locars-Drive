{% extends 'base.html' %}
{% block title %}Veículos Disponíveis{% endblock %}

{% block content %}
<!-- Incluindo o CSS correto -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

<section class="catalogo-main">
    <div class="container">
        <h1>Veículos Disponíveis para Locação</h1>
        
        <!-- INÍCIO: Botão de Cadastro para Administradores -->
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="admin-actions mb-4 text-center">
            <a href="{{ url_for('veiculos.adicionar_veiculo') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus-circle"></i> Cadastrar Novo Veículo
            </a>
        </div>
        {% endif %}
        <!-- FIM: Botão de Cadastro para Administradores -->

        <div class="catalogo-wrapper">
            
            <aside class="filtro-sidebar">
                <h3>Filtrar Busca</h3>
                <form action="{{ url_for('veiculos.veiculos') }}" method="GET">
                    
                    <div class="filtro-group">
                        <h4>Tipo de Veículo Principal</h4>
                        <select id="tipo-veiculo" name="categoria_principal" class="form-control" required style="cursor: pointer;">
                            <option value="carro" selected>Carro</option>
                            <option value="moto">Moto</option>
                            <option value="bicicleta">Bicicleta / E-Bike</option>
                            <option value="patinete">Patinete Elétrico</option>
                        </select>
                    </div>

                    <div class="filtro-group">
                        <h4>Localização</h4>
                        <input type="text" name="localizacao" placeholder="Cidade ou Endereço">
                    </div>

                    <div class="filtro-group">
                        <h4>Preço por dia</h4>
                        <input type="range" name="preco_max" min="10" max="1200" step="10" value="500"> 
                        <span id="preco-display">R$ 500</span>
                    </div>
                    
                    <div id="filtro-carro" class="filtro-condicional">
                        
                        
                        <div class="filtro-group">
                            <h4>Detalhes do Carro</h4>
                            <label><input type="checkbox" name="tipo" value="premium"> Premium / Executivo</label>
                            <label><input type="checkbox" name="transmissao" value="automatica"> Transmissão Automática</label>
                            <label><input type="checkbox" name="combustivel" value="eletrico"> Híbrido/Elétrico</label>
                        </div>

                        <div class="filtro-group">
                            <h4>Capacidade</h4>
                            <label><input type="checkbox" name="assentos" value="5"> 5 Assentos</label>
                            <label><input type="checkbox" name="portas" value="4"> 8 Assentos</label>
                        </div>
                    </div>

                    <div id="filtro-moto" class="filtro-condicional" style="display:none;">
                        <div class="filtro-group">
                            <h4>Tipo de Moto</h4>
                            <label><input type="radio" name="tipo_moto" value="scooter"> Scooter / Urbana</label>
                            <label><input type="radio" name="tipo_moto" value="esportiva"> Esportiva</label>
                            <label><input type="radio" name="tipo_moto" value="trail"> Trail / Aventura</label>
                        </div>
                        
                        <div class="filtro-group">
                            <h4>Itens Inclusos</h4>
                            <label><input type="checkbox" name="capacete" value="sim"> 2 Capacetes</label>
                            <label><input type="checkbox" name="bau" value="sim"> Baú / Bagageiro</label>
                        </div>
                        
                        <div class="filtro-group">
                            <h4>Cilindrada (CC)</h4>
                            <label><input type="checkbox" name="cc" value="baixa"> Até 160cc</label>
                            <label><input type="checkbox" name="cc" value="media"> 160cc - 500cc</label>
                            <label><input type="checkbox" name="cc" value="alta"> Acima de 500cc</label>
                        </div>
                    </div>

                    <div id="filtro-bicicleta" class="filtro-condicional" style="display:none;">
                        <div class="filtro-group">
                            <h4>Tipo e Potência</h4>
                            <label><input type="radio" name="ebike" value="sim"> Bicicleta Elétrica (E-Bike)</label>
                            <label><input type="radio" name="ebike" value="nao"> Bicicleta Comum</label>
                        </div>
                        
                        <div class="filtro-group">
                            <h4>Acessórios</h4>
                            <label><input type="checkbox" name="capacete_bike" value="sim"> Capacete Incluso</label>
                            <label><input type="checkbox" name="cesta" value="sim"> Cesta / Bagageiro</label>
                        </div>
                    </div>

                    <div id="filtro-patinete" class="filtro-condicional" style="display:none;">
                        <div class="filtro-group">
                            <h4>Características</h4>
                            <label><input type="checkbox" name="dobravel" value="sim"> Dobrável</label>
                            <label><input type="checkbox" name="velocidade_max" value="acima25"> Velocidade Máxima (+25 km/h)</label>
                            <label><input type="checkbox" name="autonomia" value="longa"> Autonomia Longa (+ 30km)</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                    <a href="{{ url_for('veiculos.veiculos') }}" class="btn btn-secondary" style="width:100%; margin-top:10px;">Limpar Filtros</a>
                </form>

            </aside>
            <main class="resultados-area">
                <p class="resultado-contagem">Mostrando {{ veiculos | length }} veículos</p>
                
                <div class="veiculos-grid">
                    
                    {% for veiculo in veiculos %}
                    <div class="veiculo-card">
                        <!-- Link para o detalhe do veículo (corrigido o endpoint) -->
                        <a href="{{ url_for('veiculos.detalhe', id_veiculo=veiculo.id_Veiculo) }}">
                            <!-- Placeholder de Imagem -->
                            <div class="card-imagem" style="background-image: url(&quot;{{ url_for('static', filename='uploads/' ~ veiculo.imagem_principal) if veiculo.imagem_principal else '../static/img/carroelse.jpg' ~ veiculo.marca.Nome_Marca }}&quot;)"></div>
                            <div class="card-info">
                                <!-- Acessando corretamente Marca e Modelo -->
                                <h2>{{ veiculo.marca.Nome_Marca }} {{ veiculo.modelo.Nome_Modelo }}</h2>
                                <p class="card-localizacao"><i class="fa-solid fa-car-on"></i> Frota: {{ veiculo.Frota }}</p>
                                
                                <div class="card-detalhes">
                                    <!-- Exibindo Categoria e Status -->
                                    <span><i class="fa-solid fa-list-ul"></i> Cat: {{ veiculo.categoria.Nome_Categoria }}</span>
                                    <span><i class="fa-solid fa-road"></i> KM: {{ veiculo.Km_Rodado }}</span>
                                </div>
                                <div class="card-preco">
                                    <!-- PLACEHOLDER: Valor Diária. Assumindo que você adicionará este campo ou uma função que o calcule -->
                                    <span class="preco-valor">R$ 150,00</span>
                                    <span class="preco-unidade">/ dia (Base)</span>
                                </div>
                                
                                <div class="card-status">
                                    <span class="status-badge status-{{ veiculo.StatusVeiculo.lower() }}">
                                        {{ veiculo.StatusVeiculo }}
                                    </span>
                                </div>
                            </div>
                        </a>
                        <!-- Botão de Locação -->
                        {% if veiculo.StatusVeiculo == 'Disponível' %}
                            <a href="{{ url_for('veiculos.detalhe', id_veiculo=veiculo.id_Veiculo) }}" class="btn btn-rent">
                                <i class="fas fa-calendar-check"></i> Alugar Agora
                            </a>
                        {% else %}
                             <button class="btn btn-disabled" disabled>
                                <i class="fas fa-ban"></i> Indisponível
                            </button>
                        {% endif %}
                    </div>
                    {% else %}
                        <p class="no-results">Nenhum veículo cadastrado na frota. Tente cadastrar um como Administrador.</p>
                    {% endfor %}
                    
                </div>
            </main>
        </div>
    </div>
</section>

<script>
    /* Lógica de Filtros Condicionais */
/* Lógica de Filtros Condicionais e Preço */
document.addEventListener('DOMContentLoaded', () => {
    const selectTipoVeiculo = document.getElementById('tipo-veiculo');
    const filtrosCondicionais = document.querySelectorAll('.filtro-condicional');
    const precoRange = document.querySelector('input[name="preco_max"]');
    const precoDisplay = document.getElementById('preco-display');
    
    // Mapeia as configurações de preço máximo para cada tipo de veículo
    const precoMaximo = {
        carro: { max: 1200, step: 10, default: 500 },
        moto: { max: 300, step: 5, default: 150 },
        bicicleta: { max: 100, step: 5, default: 50 },
        patinete: { max: 80, step: 5, default: 40 }
    };

    function atualizarFiltros() {
        const tipoSelecionado = selectTipoVeiculo.value;

        // --- 1. Exibir/Esconder Filtros ---
        filtrosCondicionais.forEach(div => {
            div.style.display = 'none';
        });

        const filtroAtivo = document.getElementById(`filtro-${tipoSelecionado}`);
        if (filtroAtivo) {
            filtroAtivo.style.display = 'block';
        }
        
        // --- 2. Ajustar o Range de Preço ---
        const config = precoMaximo[tipoSelecionado];

        if (precoRange && precoDisplay && config) {
            // Aplica os novos limites
            precoRange.min = 10; // Mantém um mínimo baixo para todos
            precoRange.max = config.max;
            precoRange.step = config.step;
            
            // Se o valor atual estiver fora do novo limite, reseta para o padrão
            if (parseInt(precoRange.value) > config.max) {
                precoRange.value = config.default;
            }
            
            // Atualiza o display
            precoDisplay.textContent = `R$ ${precoRange.value}`;
        }
    }

    // Event Listeners
    if (selectTipoVeiculo) {
        selectTipoVeiculo.addEventListener('change', atualizarFiltros);
    }
    
    if (precoRange && precoDisplay) {
        precoRange.addEventListener('input', () => {
            precoDisplay.textContent = `R$ ${precoRange.value}`;
        });
    }

    // Inicialização ao carregar a página
    atualizarFiltros(); 
});
</script>


{% endblock %}